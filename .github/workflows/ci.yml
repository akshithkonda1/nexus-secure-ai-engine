name: Ryuzen CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  ryuzen-ci:
    name: Ryuzen CI Pipeline
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            requirements/**/*.txt
            pyproject.toml

      - name: Install dependencies
        id: install
        continue-on-error: true
        run: |
          echo "Installing dependencies with compatibility for missing files..."
          set -o pipefail
          failures=0
          python -m pip install --upgrade pip || failures=1
          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            pip install -r requirements.txt || failures=1
          else
            echo "requirements.txt not found; skipping base requirement install."
          fi
          if [ -f requirements-dev.txt ]; then
            echo "Installing from requirements-dev.txt"
            pip install -r requirements-dev.txt || failures=1
          fi
          echo "Installing CI tooling"
          pip install --upgrade flake8 mypy bandit safety pytest pytest-cov || failures=1
          echo "Dependency installation finished."
          exit $failures

      # Static Analysis Stage
      - name: flake8 linting
        id: flake8
        continue-on-error: true
        run: |
          echo "Running flake8 linting..."
          flake8 .

      - name: mypy type checking
        id: mypy
        continue-on-error: true
        run: |
          echo "Running mypy type checks..."
          mypy .

      - name: bandit security scan
        id: bandit
        continue-on-error: true
        run: |
          echo "Running bandit security scan..."
          bandit -r .

      - name: safety vulnerability scan
        id: safety
        continue-on-error: true
        run: |
          echo "Running safety vulnerability scan..."
          safety check --full-report

      # Core Test Stage
      - name: Ryuzen Master Test Suite
        id: master-test
        continue-on-error: true
        run: |
          echo "Executing Ryuzen Master Test Suite..."
          set -o pipefail
          if [ -f tests/master_test.py ]; then
            python tests/master_test.py | tee master_test_output.txt
            exit ${PIPESTATUS[0]}
          else
            echo "tests/master_test.py not found" | tee master_test_output.txt
            exit 1
          fi

      # Pytest Stage
      - name: Run pytest with coverage
        id: pytest
        continue-on-error: true
        run: |
          echo "Running pytest with coverage..."
          pytest --cov=. --cov-report=xml:coverage.xml --cov-report=term

      # Artifact Uploads
      - name: Upload master test output
        id: upload-master-output
        continue-on-error: true
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: master-test-output
          path: master_test_output.txt
          retention-days: 7

      - name: Upload coverage report
        id: upload-coverage
        continue-on-error: true
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

      - name: Collect diagnostics and caches
        if: always()
        id: diagnostics
        continue-on-error: true
        run: |
          echo "Collecting diagnostics and caches..."
          mkdir -p diagnostics
          [ -f master_test_output.txt ] && cp master_test_output.txt diagnostics/ || true
          [ -f coverage.xml ] && cp coverage.xml diagnostics/ || true
          for dir in .pytest_cache .mypy_cache .cache/pip; do
            if [ -d "$dir" ]; then
              tar -czf "diagnostics/${dir##*/}.tar.gz" "$dir" || true
            fi
          done
          echo "Diagnostics collected." 

      - name: Upload diagnostics bundle
        id: upload-diagnostics
        continue-on-error: true
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics-and-caches
          path: diagnostics
          retention-days: 7

      # Self-Diagnostic Stage
      - name: Self-diagnostic and final status
        id: self-check
        if: always()
        run: |
          echo "Aggregating step statuses..."
          declare -A statuses=(
            [checkout]="${{ steps.checkout.outcome }}"
            [setup_python]="${{ steps.setup-python.outcome }}"
            [install]="${{ steps.install.outcome }}"
            [flake8]="${{ steps.flake8.outcome }}"
            [mypy]="${{ steps.mypy.outcome }}"
            [bandit]="${{ steps.bandit.outcome }}"
            [safety]="${{ steps.safety.outcome }}"
            [master_test]="${{ steps.master-test.outcome }}"
            [pytest]="${{ steps.pytest.outcome }}"
            [diagnostics]="${{ steps.diagnostics.outcome }}"
            [upload_master_output]="${{ steps.upload-master-output.outcome }}"
            [upload_coverage]="${{ steps.upload-coverage.outcome }}"
            [upload_diagnostics]="${{ steps.upload-diagnostics.outcome }}"
          )

          failures=0
          for stage in "${!statuses[@]}"; do
            result="${statuses[$stage]}"
            echo "- ${stage}: ${result}"
            if [[ "$result" != "success" ]]; then
              failures=1
            fi
          done

          master_failed=0
          if [ -f master_test_output.txt ]; then
            if grep -E "(FAIL|ERROR|FAILED)" master_test_output.txt; then
              echo "Detected failure markers in master test output."
              master_failed=1
            else
              echo "No failure markers found in master test output."
            fi
          else
            echo "master_test_output.txt is missing."
            master_failed=1
          fi

          if (( failures == 1 )) || (( master_failed == 1 )); then
            echo "Self-diagnostic detected issues; marking workflow as failed." >&2
            exit 1
          fi

          echo "All stages passed according to self-diagnostic."

name: Deploy Toron Engine Blue

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'toron/**'
      - 'deploy/blue_green/**'
      - 'k8s/**'

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy-blue:
    runs-on: ubuntu-latest
    environment: toron-blue
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run unit tests
        run: |
          pytest --maxfail=1 --disable-warnings --cov=toron --cov-report=xml

      - name: Authenticate to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t "$ECR_REGISTRY/toron-engine:${IMAGE_TAG}" .
          docker push "$ECR_REGISTRY/toron-engine:${IMAGE_TAG}"

      - name: Configure kubectl
        uses: aws-actions/eks-setup-kubectl@v1
        with:
          version: '1.29.0'

      - name: Update kubeconfig
        uses: aws-actions/eks-login@v1
        with:
          cluster-name: toron-prod
          region: us-east-1

      - name: Render manifests
        run: |
          sed "s@IMAGE_PLACEHOLDER@${{ steps.login-ecr.outputs.registry }}/toron-engine:${{ github.sha }}@" k8s/deployment.yaml > /tmp/deployment-blue.yaml
          yq e '.metadata.namespace = "toron-blue"' -i /tmp/deployment-blue.yaml

      - name: Deploy to blue namespace
        run: |
          kubectl create namespace toron-blue --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f /tmp/deployment-blue.yaml
          kubectl apply -f k8s/service.yaml -n toron-blue
          kubectl apply -f k8s/istio_destination_rule.yaml -n toron-blue
          kubectl apply -f k8s/istio_virtual_service.yaml -n toron-blue

      - name: Smoke tests
        run: |
          kubectl rollout status deployment/toron-engine -n toron-blue --timeout=300s
          kubectl -n toron-blue exec deploy/toron-engine -- curl -fsS http://localhost:8080/healthz

      - name: Publish health metrics
        run: |
          aws cloudwatch put-metric-data --namespace "Toron/Deployments" --metric-name "BlueDeploySuccess" --value 1
